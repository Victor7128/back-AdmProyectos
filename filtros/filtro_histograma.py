from fastapi import APIRouter, File, UploadFile, HTTPException
from PIL import Image
import io
import numpy as np

router = APIRouter()

TEMPLATE_HISTOGRAM = {
    "r": [3852, 2438, 1645, 2103, 2432, 1353, 1878, 1298, 1240, 1054, 1072, 927, 1016, 970, 1136, 939, 1092, 973, 1164, 927, 841, 813, 723, 734, 607, 558, 546, 555, 535, 475, 445, 349, 406, 403, 372, 340, 342, 307, 307, 248, 425, 256, 271, 244, 245, 229, 205, 230, 247, 324, 174, 171, 174, 177, 149, 169, 132, 161, 164, 145, 130, 149, 122, 107, 129, 132, 119, 109, 119, 122, 151, 134, 112, 119, 112, 120, 117, 131, 121, 135, 114, 114, 102, 98, 92, 114, 122, 129, 105, 115, 104, 130, 130, 112, 131, 104, 126, 127, 108, 106, 103, 98, 108, 105, 109, 101, 89, 87, 98, 124, 119, 104, 103, 115, 135, 99, 118, 116, 107, 95, 115, 99, 123, 123, 138, 103, 97, 117, 99, 100, 114, 114, 94, 102, 103, 85, 101, 119, 79, 106, 99, 95, 94, 102, 128, 112, 96, 121, 81, 84, 114, 100, 117, 96, 91, 111, 93, 120, 115, 114, 102, 126, 102, 94, 123, 113, 249, 121, 125, 100, 133, 114, 135, 96, 109, 111, 138, 106, 133, 129, 135, 104, 111, 175, 133, 138, 121, 155, 127, 139, 129, 117, 131, 153, 137, 149, 158, 114, 141, 159, 139, 146, 145, 164, 164, 286, 199, 168, 167, 174, 192, 158, 177, 169, 173, 200, 193, 228, 201, 213, 248, 260, 225, 276, 288, 263, 355, 331, 381, 476, 438, 469, 482, 781, 895, 944, 939, 1254, 1518, 1697, 2187, 2871, 3320, 4678, 4155, 472563, 17213, 5764, 3619, 4210, 2135, 3688, 5664, 1951, 10478, 712116],
    "g": [66, 204, 96, 72, 80, 106, 128, 105, 122, 178, 201, 189, 235, 240, 247, 301, 312, 382, 393, 413, 538, 519, 556, 680, 668, 623, 554, 501, 441, 414, 394, 329, 381, 283, 241, 247, 215, 237, 197, 176, 159, 135, 139, 136, 131, 137, 99, 130, 126, 134, 132, 151, 147, 240, 211, 323, 548, 341, 180, 164, 128, 196, 138, 85, 90, 90, 100, 94, 87, 107, 102, 103, 78, 74, 73, 101, 86, 71, 81, 69, 73, 81, 68, 62, 61, 61, 70, 83, 78, 71, 82, 76, 81, 72, 78, 56, 90, 71, 68, 72, 76, 58, 75, 63, 72, 75, 74, 71, 68, 76, 74, 80, 51, 73, 75, 81, 66, 83, 68, 80, 65, 64, 91, 74, 58, 90, 95, 67, 78, 50, 74, 80, 76, 75, 66, 67, 67, 60, 64, 80, 55, 64, 52, 70, 68, 76, 66, 59, 67, 64, 51, 60, 81, 65, 101, 77, 112, 87, 82, 144, 101, 126, 117, 133, 186, 192, 225, 228, 396, 277, 465, 366, 514, 451, 458, 454, 470, 433, 512, 659, 497, 464, 518, 726, 555, 692, 672, 773, 1084, 1278, 2834, 2152, 1367, 948, 670, 555, 453, 372, 359, 338, 311, 290, 275, 242, 263, 259, 259, 266, 264, 269, 302, 234, 278, 315, 329, 329, 347, 349, 363, 366, 394, 365, 368, 363, 360, 408, 421, 595, 924, 1938, 642, 440, 403, 460, 466, 496, 584, 663, 869, 1022, 1267, 1486, 1892, 2383, 3192, 5533, 22544, 468649, 4648, 4728, 3168, 2903, 2996, 4619, 8371, 728445],
    "b": [20, 2, 107, 25, 170, 108, 76, 98, 81, 127, 121, 144, 169, 198, 219, 231, 246, 262, 296, 341, 364, 401, 419, 480, 464, 548, 626, 713, 576, 527, 508, 473, 447, 405, 345, 317, 323, 291, 252, 204, 216, 210, 162, 147, 128, 155, 132, 133, 133, 115, 102, 100, 93, 93, 90, 100, 139, 130, 85, 108, 91, 71, 99, 81, 90, 89, 114, 100, 117, 132, 128, 171, 221, 279, 391, 531, 653, 855, 1678, 3226, 1192, 1318, 1024, 977, 651, 635, 568, 474, 390, 378, 323, 345, 283, 323, 244, 238, 220, 237, 219, 223, 157, 235, 217, 137, 128, 132, 145, 139, 149, 119, 111, 115, 131, 121, 105, 110, 125, 103, 123, 130, 115, 106, 96, 115, 133, 104, 109, 88, 105, 106, 110, 111, 99, 122, 98, 131, 113, 110, 98, 121, 103, 98, 148, 104, 124, 111, 113, 89, 99, 143, 96, 104, 106, 102, 109, 128, 106, 136, 159, 162, 180, 162, 227, 190, 232, 386, 153, 326, 170, 209, 151, 195, 118, 104, 127, 131, 121, 134, 121, 111, 138, 127, 113, 136, 103, 115, 168, 129, 150, 117, 131, 160, 138, 141, 156, 132, 155, 139, 133, 159, 318, 150, 221, 210, 196, 186, 232, 229, 272, 270, 287, 269, 346, 298, 609, 420, 2188, 850, 464, 654, 520, 563, 430, 494, 442, 428, 449, 436, 436, 543, 496, 529, 530, 602, 588, 596, 682, 865, 935, 1133, 1368, 1707, 2299, 2946, 5676, 5272, 477158, 5761, 10748, 4587, 4279, 4927, 2395, 7769, 3605, 724713],
}

def compare_histograms(template, target):
    min_len = min(len(template), len(target))
    template = np.array(template[:min_len], dtype=np.float64)
    target = np.array(target[:min_len], dtype=np.float64)

    if np.std(template) == 0 or np.std(target) == 0:
        return 0.0

    corr = np.corrcoef(template, target)[0, 1]
    similarity = max(0.0, min(1.0, (corr + 1) / 2))
    return similarity * 100

@router.post("/histograma")
async def histograma(file: UploadFile = File(...)):
    try:
        contents = await file.read()
        image = Image.open(io.BytesIO(contents)).convert("RGB")
    except Exception:
        raise HTTPException(status_code=400, detail="No se pudo procesar la imagen. Asegúrese de que el archivo sea una imagen válida.")

    try:
        histogram = image.histogram()
        r = histogram[0:256]
        g = histogram[256:512]
        b = histogram[512:768]
    except Exception:
        raise HTTPException(status_code=500, detail="Error al calcular el histograma de la imagen.")
    similitud_r = compare_histograms(TEMPLATE_HISTOGRAM["r"], r)
    similitud_g = compare_histograms(TEMPLATE_HISTOGRAM["g"], g)
    similitud_b = compare_histograms(TEMPLATE_HISTOGRAM["b"], b)
    similitud_total = (similitud_r + similitud_g + similitud_b) / 3

    response = {
        "r": r,
        "g": g,
        "b": b,
        "similitud": round(similitud_total, 2)
    }
    
    if similitud_total <= 98:
        response["advertencia"] = (
            "Sospechoso"
        )
    elif similitud_total <= 90:
        response["advertencia"] = (
            "Alterado"
        )
    else:
        response["advertencia"] = (
            "Auténtico"
        )

    return response